image: node:16.14.0-alpine3.15

stages:
  - build-app
  - test-integration

build:
  stage: build-app
  script:
    - cd app-blog && yarn install --frozen-lockfile && yarn build
  artifacts:
    expire_in: 10 days
    paths:
      - app-blog/dist/

test:
  stage: test-integration
  image: openjdk:17.0.2-slim-buster
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  services:
    - docker:19.03.13-dind
  script:
    - apt-get update && apt-get install -y docker docker-compose bash curl
    - docker network create test-network
    - ./app-blog/scripts/docker/run.sh
    - ./scripts/wait-for-service-ready.sh http://docker:5250/posts 200 app
    - >
      docker run --name claims-form-test --network test-network --mount type=bind,source=$(pwd),target="/claims"
      --entrypoint /bin/bash openjdk:17.0.2-slim-buster
      -c "cd claims && ./install.sh && cd cucumber && ls -la && ./gradlew cucumber -Denv=headless"
