image: node:16.14.0-alpine3.15

stages:
  - build-app
  - build-container
  - test-integration

build:
  stage: build-app
  script:
    - cd service-blog
    - yarn install --frozen-lockfile
    - yarn build
  artifacts:
    expire_in: 10 days
    paths:
      - service-blog/dist/
  rules:
  - changes:
      - service-blog/**/*

build app image:
  stage: build-container
  image: docker
  needs:
    - build
  dependencies:
    - build
  services:
    - docker:19.03.13-dind
  script:
    - docker login --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE/service-blog -f ./service-blog/scripts/docker/Dockerfile .
    - docker push $CI_REGISTRY_IMAGE/service-blog
  rules:
  - changes:
      - app-blog/**/*

build cucumber image:
  stage: build-container
  image: docker
  services:
    - docker:19.03.13-dind
  script:
    - docker login --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE/cucumber -f ./scripts/docker/Dockerfile-cucumber .
    - docker push $CI_REGISTRY_IMAGE/cucumber
  rules:
  - changes:
      - scripts/docker/Dockerfile-cucumber

test:
  stage: test-integration
  image: $CI_REGISTRY_IMAGE/cucumber
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  services:
    - name: $CI_REGISTRY_IMAGE/blog-api
      alias: blog-api
  script:
    - ./scripts/wait-for-service-ready.sh http://blog-api:5250/posts 200 app
    - cd test
    - gradle cucumber -Denv=ci

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
